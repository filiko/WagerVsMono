<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign Management</title>
    <link rel="stylesheet" href="cms.css" />
    <script src="config.js" defer></script> <!-- ✅ Load Global Config -->
    <script src="checkAuth.js" defer></script> <!-- ✅ Load Global Config -->
</head>
<body>
    <!-- ✅ Admin Portal Button -->
    <div class="top-bar">
        <button class="admin-btn" onclick="adminUrl()">Admin
            Portal</button>
            </div>
    <div class="container">
        <h2>Campaign Management</h2>

        <!-- Campaign Selector -->
        <div class="form-group">
            <label for="campaignSelector">Select Campaign:</label>
            <select id="campaignSelector" onchange="loadCampaign()">
                <option value="">New Campaign</option>
            </select>
        </div>

        <!-- Campaign Name -->
        <div class="form-group">
            <label for="name">Campaign Name:</label>
            <input type="text" id="name" required>
        </div>

        <!-- Campaign Description -->
        <div class="form-group">
            <label for="description">Description:</label>
            <textarea id="description" rows="3"></textarea>
        </div>

        <!-- AI Prediction -->
        <div class="form-group">
            <label for="AiPrediction">AI Prediction:</label>
            <input type="text" id="AiPrediction" required>
        </div>

        <!-- AI Reason -->
        <div class="form-group">
            <label for="AIReason">AI Reason:</label>
            <textarea id="AIReason" rows="3"></textarea>
        </div>

        <!-- Upload Image -->
        <div class="form-group">
            <label for="image">Upload Image:</label>
            <input type="file" id="image" accept="image/*" onchange="previewImage()">
            <img id="imagePreview" class="image-preview" src="" alt="Preview">
        </div>

        <!-- Left Button -->
        <div class="form-group">
            <label for="left_button">Left Button Text:</label>
            <input type="text" id="left_button" required>
        </div>
  
        <!-- Left Wallet Button -->
        <div class="form-group">
            <label for="leftWallet">Left Wallet:</label>
            <input type="text" id="leftWallet" required>
        </div>

        <!-- Right Button -->
        <div class="form-group">
            <label for="right_button">Right Button Text:</label>
            <input type="text" id="right_button" required>
        </div>

        <!-- Right Wallet Button -->
        <div class="form-group">
            <label for="rightWallet">Right Wallet:</label>
            <input type="text" id="rightWallet" required>
        </div>

        <!-- Action Buttons -->
        <div class="button-group">
            <button class="btn btn-primary" onclick="saveCampaign()">Save Campaign</button>
            <button class="btn btn-danger" onclick="deleteCampaign()">Delete Campaign</button>
        </div>
    </div>

    <script>

        async function loadCampaigns() {
            try {
                const response = await fetch(`${API_BASE_URL}/allcampaigns`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

                const campaigns = await response.json();
                const selector = document.getElementById("campaignSelector");
                selector.innerHTML = '<option value="">New Campaign</option>';

                campaigns.forEach(campaign => {
                    const option = document.createElement("option");
                    option.value = campaign.campaign_id;
                    option.textContent = campaign.name;
                    selector.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading campaigns:", error);
            }
        }

        async function loadCampaign() {
            const campaignId = document.getElementById("campaignSelector").value;
            if (!campaignId) return clearForm();

            try {
                const response = await fetch(`${API_BASE_URL}/campaign/${campaignId}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

                const campaign = await response.json();

                document.getElementById("name").value = campaign.name || "";
                document.getElementById("description").value = campaign.description || "";
                document.getElementById("left_button").value = campaign.left_button || "Left";
                document.getElementById("leftWallet").value = campaign.leftWallet || "LeftWallet";
                document.getElementById("right_button").value = campaign.right_button || "Right";
                document.getElementById("rightWallet").value = campaign.rightWallet || "RightWallet";
                document.getElementById("AiPrediction").value = campaign.AiPrediction || "";
                document.getElementById("AIReason").value = campaign.AIReason || "";

                const imageUrl = campaign.image_url ? `path/to/images/${campaign.image_url}` : ""; // Adjust the path as needed
                document.getElementById("imagePreview").src = imageUrl;
            } catch (error) {
                console.error("Error loading campaign:", error);
            }
        }

        async function saveCampaign() {
            const name = document.getElementById("name").value.trim();
            const description = document.getElementById("description").value.trim();
            const left_button = document.getElementById("left_button").value.trim();
            const leftWallet = document.getElementById("leftWallet").value.trim();
            const right_button = document.getElementById("right_button").value.trim();
            const rightWallet = document.getElementById("rightWallet").value.trim();
            const AiPrediction = document.getElementById("AiPrediction").value.trim();
            const AIReason = document.getElementById("AIReason").value.trim();
            const imageInput = document.getElementById("image");

            if (!name || !description || !left_button || !leftWallet || !right_button || !rightWallet || !AiPrediction || !AIReason) {
                alert("❌ Please complete all fields before saving.");
                return;
            }

            const formData = new FormData();
            formData.append("name", name);
            formData.append("description", description);
            formData.append("left_button", left_button);
            formData.append("leftWallet", leftWallet);
            formData.append("right_button", right_button);
            formData.append("rightWallet", rightWallet);
            formData.append("AiPrediction", AiPrediction);
            formData.append("AIReason", AIReason);

            if (imageInput.files.length > 0) {
                const fileName = imageInput.files[0].name; // Extract the file name
                formData.append("image_url", fileName); // Append only the file name
            }

            const campaignId = document.getElementById("campaignSelector").value;
            const endpoint = campaignId ? `${API_BASE_URL}/campaign/${campaignId}` : `${API_BASE_URL}/campaign`;
            const method = campaignId ? "PUT" : "POST";

            try {
                const response = await fetch(endpoint, { method, body: formData });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || "Failed to save campaign.");
                alert("✅ Campaign saved successfully!");
                loadCampaigns();
            } catch (error) {
                console.error("❌ Error saving campaign:", error);
            }
        }

        async function deleteCampaign() {
            const campaignId = document.getElementById("campaignSelector").value;
            if (!campaignId) {
                alert("❌ No campaign selected.");
                return;
            }

            if (!confirm("⚠️ Are you sure you want to delete this campaign?")) return;

            try {
                const response = await fetch(`${API_BASE_URL}/campaign/${campaignId}`, {
                    method: "DELETE",
                });

                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.error || "Failed to delete campaign.");
                }

                alert(`✅ Campaign deleted successfully!`);
                loadCampaigns();
                clearForm();
            } catch (error) {
                console.error("❌ Error deleting campaign:", error);
                alert("❌ Error deleting campaign.");
            }
        }

        function clearForm() {
            document.getElementById("name").value = "";
            document.getElementById("description").value = "";
            document.getElementById("left_button").value = "";
            document.getElementById("right_button").value = "";
            document.getElementById("leftWallet").value = "";
            document.getElementById("rightWallet").value = "";
            document.getElementById("AiPrediction").value = "";
            document.getElementById("AIReason").value = "";
            document.getElementById("image").value = "";
            document.getElementById("imagePreview").src = "";
        }

        function previewImage() {
            const imageInput = document.getElementById("image");
            const imagePreview = document.getElementById("imagePreview");

            if (imageInput.files && imageInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else {
                imagePreview.src = "";
            }
        }

        document.addEventListener("DOMContentLoaded", loadCampaigns);
    </script>
</body>
</html>
